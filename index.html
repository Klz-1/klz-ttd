<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>KLZ TTD</title>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<meta name="google-signin-client_id" content="1314891293-o1g7g9f673t9flr5vi2mkvr7p6uvcr3t.apps.googleusercontent.com">

<!-- iOS add-to-home-screen niceties -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="KLZ">

<style>
  :root { 
    --fg:#000000; 
    --bg:#fafafa; 
    --card:#ffffff;
    --muted:#64748b; 
    --sep:#e2e8f0; 
    --accent:#3b82f6; 
    --accent-light:#dbeafe;
    --ok:#10b981; 
    --warn:#f59e0b;
    --shadow: 0 1px 3px rgba(0,0,0,0.08);
    --shadow-lg: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  * { 
    box-sizing:border-box; 
    -webkit-tap-highlight-color:transparent; 
  }
  
  html,body { 
    height:100%; 
  }
  
  body { 
    margin:0; 
    font:15px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; 
    color:var(--fg); 
    background:var(--bg); 
    -webkit-font-smoothing: antialiased;
  }

  /* Header with glassmorphism */
  header { 
    position:sticky; 
    top:0; 
    z-index:10; 
    backdrop-filter:saturate(1.8) blur(20px);
    background:rgba(250,250,250,.72); 
    border-bottom:1px solid var(--sep); 
  }
  
  .bar { 
    max-width:640px; 
    margin:0 auto; 
    display:flex; 
    align-items:center; 
    gap:12px; 
    padding:14px 16px; 
  }
  
  h1 { 
    font-size:17px; 
    font-weight:700; 
    margin:0; 
    letter-spacing:-0.3px;
  }
  
  .grow { flex:1; }
  
  /* Refined buttons */
  .btn { 
    appearance:none; 
    border:none;
    background:var(--card); 
    color:var(--fg);
    padding:7px 12px; 
    border-radius:20px; 
    font-size:14px;
    font-weight:600; 
    cursor:pointer;
    box-shadow: var(--shadow);
    transition: all 0.15s ease;
  }
  
  .btn:active {
    transform: scale(0.96);
  }
  
  .btn.primary { 
    background:var(--accent); 
    color:#fff;
  }
  
  .btn.primary:hover {
    background:#2563eb;
  }
  
  /* Tab pills */
  .tabs { 
    display:flex; 
    gap:6px;
    background:var(--sep);
    padding:2px;
    border-radius:20px;
  }
  
  .tab { 
    padding:5px 14px; 
    border-radius:18px; 
    font-size:13px; 
    font-weight:600;
    color:var(--muted); 
    cursor:pointer;
    transition: all 0.2s ease;
  }
  
  .tab.active { 
    background:var(--card); 
    color:var(--accent);
    box-shadow: var(--shadow);
  }

  /* Main content area */
  main { 
    max-width:640px; 
    margin:0 auto; 
    padding:16px 16px 32px; 
  }
  
  /* Task cards with better shadows */
  .list .item { 
    position:relative; 
    display:flex; 
    align-items:center; 
    gap:14px; 
    padding:16px; 
    background:var(--card);
    border:1px solid var(--sep); 
    border-radius:16px; 
    margin:12px 0; 
    overflow:hidden;
    box-shadow: var(--shadow);
    transition: all 0.2s ease;
    cursor:pointer;
  }
  
  .list .item:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-1px);
  }
  
  .list .item:active {
    transform: scale(0.99);
  }
  
  .item .meta { 
    flex:1; 
    min-width:0; 
  }
  
  .title { 
    font-weight:600; 
    font-size:15px;
    letter-spacing:-0.2px;
    white-space:nowrap; 
    overflow:hidden; 
    text-overflow:ellipsis;
    margin-bottom:2px;
  }
  
  .sub { 
    color:var(--muted); 
    font-size:13px; 
    white-space:nowrap; 
    overflow:hidden; 
    text-overflow:ellipsis; 
  }
  
  /* Priority indicators */
  .pill { 
    font-size:11px; 
    font-weight:600;
    padding:3px 10px; 
    border-radius:12px; 
    background:var(--accent-light);
    color:var(--accent);
    letter-spacing:0.3px;
    text-transform:uppercase;
  }
  
  .pill.high {
    background:#fee2e2;
    color:#dc2626;
  }
  
  .item.done { 
    opacity:.35; 
  }
  
  /* Modern checkbox */
  .checkbox {
    width: 22px;
    height: 22px;
    border: 2px solid var(--sep);
    border-radius: 11px;
    cursor: pointer;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    background: var(--card);
    position:relative;
  }
  
  .checkbox:hover {
    border-color: var(--accent);
    background: var(--accent-light);
  }
  
  .checkbox.checked {
    background: var(--accent);
    border-color: var(--accent);
    transform: scale(0.9);
  }
  
  .checkbox.checked::after {
    content: '';
    position: absolute;
    width: 6px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    margin-bottom: 2px;
  }
  
  /* Completion animation */
  .item.completing {
    animation: slideComplete 0.35s ease forwards;
  }
  
  @keyframes slideComplete {
    to {
      transform: translateX(30px);
      opacity: 0;
    }
  }

  /* Detail view */
  .detail { 
    display:none; 
    padding:20px 0; 
  }
  
  .back { 
    color:var(--accent); 
    font-weight:600; 
    cursor:pointer; 
    display:inline-flex;
    align-items:center;
    gap:4px;
    margin:0 0 20px;
    font-size:14px;
    transition: all 0.15s ease;
  }
  
  .back:hover {
    gap:8px;
  }
  
  .d-title { 
    font-size:20px; 
    font-weight:700; 
    margin:0 0 8px;
    letter-spacing:-0.5px;
    line-height:1.3;
  }
  
  .d-meta { 
    color:var(--muted); 
    font-size:14px;
    margin-bottom:16px;
  }
  
  .d-snippet { 
    margin:20px 0;
    padding:16px;
    background:var(--bg);
    border-radius:12px;
    font-size:14px;
    line-height:1.6;
    color:var(--muted);
  }
  
  #dActions {
    display:flex;
    gap:10px;
    margin-top:24px;
  }
  
  #dActions .btn {
    flex:1;
  }

  /* Toast notifications */
  .toast { 
    position:fixed; 
    left:50%; 
    bottom:24px; 
    transform:translateX(-50%) translateY(100px);
    background:var(--fg); 
    color:var(--card); 
    padding:12px 20px; 
    border-radius:24px; 
    font-size:14px;
    font-weight:600;
    opacity:0; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow-lg);
  }
  
  .toast.show { 
    opacity:1;
    transform:translateX(-50%) translateY(0);
  }

  /* Empty states */
  .empty { 
    color:var(--muted); 
    text-align:center; 
    padding:48px 20px;
    font-size:15px;
    line-height:1.6;
  }
  
  /* Loading animation */
  .loading { 
    color:var(--muted); 
    text-align:center; 
    padding:48px 20px;
    font-size:14px;
    position:relative;
  }
  
  .loading::after {
    content: '';
    display: block;
    width: 20px;
    height: 20px;
    margin: 16px auto 0;
    border: 2px solid var(--sep);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .error {
    color:#dc2626;
    text-align:center;
    padding:48px 20px;
    font-size:14px;
    line-height:1.6;
  }

  /* Login Overlay */
  .login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .login-card {
    background: var(--card);
    padding: 32px;
    border-radius: 16px;
    text-align: center;
    max-width: 400px;
    box-shadow: var(--shadow-lg);
  }

  .login-card h2 {
    margin: 0 0 16px;
    font-size: 24px;
    font-weight: 700;
  }

  .login-card p {
    color: var(--muted);
    margin: 0 0 24px;
    line-height: 1.5;
  }

  /* User Info */
  .user-info {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .user-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
  }

  .user-email {
    font-size: 13px;
    color: var(--muted);
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .user-info .btn {
    padding: 4px 8px;
    font-size: 12px;
    min-width: auto;
  }

  /* Add subtle entrance animations */
  .item {
    animation: fadeInUp 0.3s ease backwards;
  }
  
  .item:nth-child(1) { animation-delay: 0.05s; }
  .item:nth-child(2) { animation-delay: 0.1s; }
  .item:nth-child(3) { animation-delay: 0.15s; }
  .item:nth-child(4) { animation-delay: 0.2s; }
  .item:nth-child(5) { animation-delay: 0.25s; }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .bar {
      padding: 12px 12px;
    }
    main {
      padding: 12px 12px 32px;
    }
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    :root {
      --fg:#ffffff;
      --bg:#0f0f0f;
      --card:#1a1a1a;
      --muted:#94a3b8;
      --sep:#262626;
      --accent:#3b82f6;
      --accent-light:#1e3a5f;
      --shadow: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-lg: 0 4px 12px rgba(0,0,0,0.4);
    }
    
    header {
      background:rgba(15,15,15,.72);
    }
    
    .tabs {
      background:#262626;
    }
    
    .tab.active {
      background:var(--card);
    }
    
    .toast {
      background:var(--card);
      color:var(--fg);
    }
  }
</style>
</head>
<body>

<header>
  <div class="bar">
    <h1>KLZ</h1>
    <div class="tabs">
      <div id="tabTasks" class="tab active">Tasks</div>
      <div id="tabCompleted" class="tab">Completed</div>
      <div id="tabNotes" class="tab">Notes</div>
    </div>
    <div class="grow"></div>
    <div id="userInfo" class="user-info" style="display:none;">
      <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
      <button id="signOutBtn" class="btn">Sign Out</button>
    </div>
    <button id="addTaskBtn" class="btn primary">+ Add</button>
    <button id="refreshBtn" class="btn">↻</button>
  </div>
</header>

<!-- Login Overlay -->
<div id="loginOverlay" class="login-overlay" style="display:none;">
  <div class="login-card">
    <h2>Sign in to KLZ TTD</h2>
    <p>Please sign in with your Google account to access your tasks.</p>
    <div id="g_id_onload"
         data-client_id="1314891293-o1g7g9f673t9flr5vi2mkvr7p6uvcr3t.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="sign_in_with"
         data-shape="rectangular"
         data-logo_alignment="left">
    </div>
  </div>
</div>

<main>
  <!-- TASKS LIST -->
  <section id="viewTasks" class="list">
    <div class="loading">Loading tasks</div>
  </section>

  <!-- COMPLETED TASKS LIST -->
  <section id="viewCompleted" class="list" style="display:none;">
    <div class="loading">Loading completed tasks</div>
  </section>

  <!-- NOTES LIST -->
  <section id="viewNotes" class="list" style="display:none;">
    <div class="loading">Loading notes</div>
  </section>

  <!-- DETAIL VIEW (shared) -->
  <section id="detail" class="detail">
    <div class="back" id="backBtn">← Back</div>
    <h2 id="dTitle" class="d-title"></h2>
    <div id="dMeta" class="d-meta"></div>
    <p id="dSnippet" class="d-snippet"></p>
    <div id="dActions"></div>
  </section>
</main>

<div id="toast" class="toast"></div>

<script>
// CONFIGURATION - Update these with your n8n webhook URLs
const API_CONFIG = {
  GET_TASKS_URL: 'https://n8n.chouseservice.com/webhook/get-tasks',
  GET_NOTES_URL: 'https://n8n.chouseservice.com/webhook/get-notes',
  COMPLETE_TASK_URL: 'https://n8n.chouseservice.com/webhook/complete-task',
  SECRET: 'klz-ttd'
};

const GOOGLE_CLIENT_ID = '1314891293-o1g7g9f673t9flr5vi2mkvr7p6uvcr3t.apps.googleusercontent.com'; // Replace with your actual Client ID

let STATE = {
  tasks: [],
  completedTasks: [],
  notes: [],
  mode: 'tasks',
  current: null,
  user: null,
  token: null
};

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function toast(msg) {
  const t = $('#toast'); 
  t.textContent = msg; 
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

function escapeHtml(s='') {
  return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}

// Authentication Functions
function handleCredentialResponse(response) {
  const token = response.credential;

  // Decode JWT to get user info (basic decode, validation happens server-side)
  const payload = JSON.parse(atob(token.split('.')[1]));

  STATE.user = {
    email: payload.email,
    name: payload.name,
    picture: payload.picture
  };
  STATE.token = token;

  // Store in session storage
  sessionStorage.setItem('google_token', token);
  sessionStorage.setItem('user_info', JSON.stringify(STATE.user));

  showMainApp();
  loadTasks();
}

function checkAuth() {
  const token = sessionStorage.getItem('google_token');
  const userInfo = sessionStorage.getItem('user_info');

  if (token && userInfo) {
    STATE.token = token;
    STATE.user = JSON.parse(userInfo);
    showMainApp();
    return true;
  }

  showLogin();
  return false;
}

function showLogin() {
  $('#loginOverlay').style.display = 'flex';
  $('main').style.display = 'none';
  $('header').style.display = 'none';
}

function showMainApp() {
  $('#loginOverlay').style.display = 'none';
  $('main').style.display = 'block';
  $('header').style.display = 'block';

  // Update user info in header
  $('#userAvatar').src = STATE.user.picture;
  $('#userAvatar').title = STATE.user.email; // Show email on hover
  $('#userInfo').style.display = 'flex';
}

function signOut() {
  sessionStorage.removeItem('google_token');
  sessionStorage.removeItem('user_info');
  STATE.user = null;
  STATE.token = null;
  if (window.google && google.accounts && google.accounts.id) {
    google.accounts.id.disableAutoSelect();
  }
  showLogin();
}

// API Functions with Authentication
async function apiCall(url, options = {}) {
  if (!STATE.token) {
    showLogin();
    throw new Error('Not authenticated');
  }

  const headers = {
    'Authorization': `Bearer ${STATE.token}`,
    'X-User-ID': STATE.user.email,
    ...options.headers
  };

  try {
    const response = await fetch(url, {
      ...options,
      headers
    });

    if (response.status === 401) {
      // Token expired or invalid
      signOut();
      throw new Error('Authentication failed');
    }

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    return await response.json();
  } catch (error) {
    console.error('API call failed:', error);
    throw error;
  }
}

async function loadTasks() {
  const wrap = $('#viewTasks');
  wrap.innerHTML = '<div class="loading">Loading tasks</div>';

  try {
    const data = await apiCall(API_CONFIG.GET_TASKS_URL);
    STATE.tasks = data.active || data.rows || [];
    STATE.completedTasks = data.completed || [];
    renderTasks();
  } catch (err) {
    console.error('Failed to load tasks:', err);
    wrap.innerHTML = '<div class="error">Failed to load tasks.<br>Check your connection and try again.</div>';
    toast('Connection error');
  }
}

async function loadNotes() {
  const wrap = $('#viewNotes');
  wrap.innerHTML = '<div class="loading">Loading notes</div>';

  try {
    const data = await apiCall(API_CONFIG.GET_NOTES_URL);
    STATE.notes = data.rows || [];
    renderNotes();
  } catch (err) {
    console.error('Failed to load notes:', err);
    wrap.innerHTML = '<div class="error">Failed to load notes.<br>Check your connection and try again.</div>';
    toast('Connection error');
  }
}

async function completeTask(task_id) {
  try {
    const result = await apiCall(API_CONFIG.COMPLETE_TASK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        task_id: task_id,
        secret: API_CONFIG.SECRET
      })
    });

    if (result.ok) {
      toast('✓ Done');
      return true;
    } else {
      toast('Failed to update');
      return false;
    }
  } catch (err) {
    console.error('Failed to complete task:', err);
    toast('Failed to update');
    return false;
  }
}

/* ---------- RENDERERS ---------- */
function renderTasks() {
  $('#detail').style.display = 'none';
  $('#viewNotes').style.display = 'none';
  $('#viewCompleted').style.display = 'none';
  const wrap = $('#viewTasks');
  wrap.style.display = 'block';
  wrap.innerHTML = '';

  if (!STATE.tasks.length) {
    wrap.innerHTML = `<div class="empty">No open tasks<br><span style="font-size:32px;">✨</span><br>Enjoy the calm</div>`;
    return;
  }

  STATE.tasks.forEach((t, idx) => {
    const el = document.createElement('div');
    el.className = 'item';
    el.dataset.index = idx;
    el.dataset.taskId = t.task_id;

    // Create checkbox element
    const checkbox = document.createElement('div');
    checkbox.className = 'checkbox';
    checkbox.addEventListener('click', async (e) => {
      e.stopPropagation(); // Prevent opening detail view
      checkbox.classList.add('checked');
      el.classList.add('completing');
      
      // Wait for animation
      setTimeout(async () => {
        const success = await completeTask(t.task_id);
        if (success) {
          STATE.tasks = STATE.tasks.filter(x => x.task_id !== t.task_id);
          renderTasks();
        } else {
          // Reset if failed
          checkbox.classList.remove('checked');
          el.classList.remove('completing');
        }
      }, 350);
    });

    // Click on item (not checkbox) opens detail
    el.addEventListener('click', (e) => {
      if (!e.target.classList.contains('checkbox')) {
        openTaskDetail(t);
      }
    });

    // Swipe to complete
    let startX = 0, swiped = false;
    el.addEventListener('touchstart', e => { startX = e.touches[0].clientX; swiped = false; });
    el.addEventListener('touchmove', e => {
      const dx = Math.max(0, e.touches[0].clientX - startX);
      el.style.transform = `translateX(${dx}px)`;
      el.style.opacity = 1 - (dx / 300);
      if (dx > 100) swiped = true;
    });
    el.addEventListener('touchend', async e => {
      if (swiped) {
        el.classList.add('completing');
        setTimeout(async () => {
          const success = await completeTask(t.task_id);
          if (success) {
            STATE.tasks = STATE.tasks.filter(x => x.task_id !== t.task_id);
            renderTasks();
          } else {
            el.style.transform = 'translateX(0)';
            el.style.opacity = '1';
          }
        }, 350);
      } else {
        el.style.transform = 'translateX(0)';
        el.style.opacity = '1';
      }
    });

    // Priority-based pill class
    const priority = t.priority || 'P2';
    const pillClass = priority === 'P1' ? 'pill high' : 'pill';

    el.innerHTML = `
      <div class="meta">
        <div class="title">${escapeHtml(t.action || 'Untitled task')}</div>
        <div class="sub">
          ${escapeHtml(t.owner || 'Unassigned')}
          ${t.due_date_iso ? ' • Due ' + escapeHtml(t.due_date_iso) : ''}
        </div>
      </div>
      <span class="${pillClass}">${escapeHtml(priority)}</span>
    `;
    
    // Append checkbox to the right
    el.appendChild(checkbox);
    wrap.appendChild(el);
  });
}

function renderCompleted() {
  $('#detail').style.display = 'none';
  $('#viewTasks').style.display = 'none';
  $('#viewNotes').style.display = 'none';
  const wrap = $('#viewCompleted');
  wrap.style.display = 'block';
  wrap.innerHTML = '';

  if (!STATE.completedTasks.length) {
    wrap.innerHTML = `<div class="empty">No completed tasks yet<br><span style="font-size:32px;">✓</span><br>Complete some tasks!</div>`;
    return;
  }

  STATE.completedTasks.forEach((t, idx) => {
    const el = document.createElement('div');
    el.className = 'item done';
    el.dataset.index = idx;
    el.dataset.taskId = t.task_id;

    // Click on item opens detail
    el.addEventListener('click', () => openTaskDetail(t));

    el.innerHTML = `
      <div class="meta">
        <div class="title">${escapeHtml(t.action || 'Untitled task')}</div>
        <div class="sub">
          ${escapeHtml(t.owner || 'Unassigned')}
          ${t.due_date_iso ? ' • Due ' + escapeHtml(t.due_date_iso) : ''}
          • Completed
        </div>
      </div>
      <span class="pill">Done</span>
    `;
    wrap.appendChild(el);
  });
}

function renderNotes() {
  $('#detail').style.display = 'none';
  $('#viewTasks').style.display = 'none';
  $('#viewCompleted').style.display = 'none';
  const wrap = $('#viewNotes');
  wrap.style.display = 'block';
  wrap.innerHTML = '';

  if (!STATE.notes.length) {
    wrap.innerHTML = `<div class="empty">No notes yet<br><span style="font-size:32px;">📝</span><br>Record your thoughts</div>`;
    return;
  }

  STATE.notes.forEach(n => {
    const el = document.createElement('div');
    el.className = 'item';
    el.addEventListener('click', () => openNoteDetail(n));
    el.innerHTML = `
      <div class="meta">
        <div class="title">${escapeHtml(n.title || 'Untitled note')}</div>
        <div class="sub">${escapeHtml(n.created_at || '')}</div>
      </div>
      <span class="pill">Note</span>
    `;
    wrap.appendChild(el);
  });
}

/* ---------- DETAIL VIEWS ---------- */
function openTaskDetail(t) {
  STATE.current = { type:'task', data:t };
  $('#viewTasks').style.display = 'none';
  $('#viewNotes').style.display = 'none';
  $('#detail').style.display = 'block';

  $('#dTitle').textContent = t.action || 'Untitled task';
  $('#dMeta').textContent = [
    t.owner || 'Unassigned',
    t.due_date_iso ? `Due ${t.due_date_iso}` : '',
    t.priority || 'P2',
  ].filter(Boolean).join(' • ');
  $('#dSnippet').textContent = t.transcript_snippet || '';
  $('#dSnippet').style.display = t.transcript_snippet ? 'block' : 'none';

  $('#dActions').innerHTML = `
    <button class="btn" onclick="shareText('${encodeURIComponent(t.action || '')}')">Share</button>
    ${t.transcript_uri ? `<button class="btn" onclick="openLink('${(t.transcript_uri||'').replace(/'/g,'%27')}')">Source</button>` : ''}
    <button class="btn primary" onclick="completeAndBack('${(t.task_id||'').replace(/'/g,'%27')}')">Complete</button>
  `;
}

function openNoteDetail(n) {
  STATE.current = { type:'note', data:n };
  $('#viewTasks').style.display = 'none';
  $('#viewNotes').style.display = 'none';
  $('#detail').style.display = 'block';

  $('#dTitle').textContent = n.title || 'Untitled note';
  $('#dMeta').textContent  = n.created_at || '';
  $('#dSnippet').textContent = n.summary || '';
  $('#dSnippet').style.display = n.summary ? 'block' : 'none';

  $('#dActions').innerHTML = `
    <button class="btn" onclick="shareText('${encodeURIComponent(n.summary || n.title || '')}')">Share</button>
    ${n.transcript_uri ? `<button class="btn" onclick="openLink('${(n.transcript_uri||'').replace(/'/g,'%27')}')">Source</button>` : ''}
  `;
}

/* ---------- ACTIONS ---------- */
async function completeAndBack(task_id) {
  const success = await completeTask(task_id);
  if (success) {
    // remove from list immediately
    STATE.tasks = STATE.tasks.filter(x => x.task_id !== task_id);
    $('#detail').style.display = 'none';
    if (STATE.mode === 'tasks') {
      $('#viewTasks').style.display = 'block';
      renderTasks();
    } else if (STATE.mode === 'completed') {
      $('#viewCompleted').style.display = 'block';
    } else {
      $('#viewNotes').style.display = 'block';
    }
  }
}

function openLink(url) {
  if (!url) { toast('No link'); return; }
  window.open(url, '_blank', 'noopener');
}

function shareText(encoded) {
  const text = decodeURIComponent(encoded || '');
  if (navigator.share) {
    navigator.share({ text }).catch(()=>{});
  } else {
    navigator.clipboard?.writeText(text);
    toast('Copied');
  }
}

/* ---------- NAV / EVENTS ---------- */
$('#backBtn').onclick = () => {
  $('#detail').style.display = 'none';
  if (STATE.mode === 'tasks') {
    $('#viewTasks').style.display = 'block';
  } else if (STATE.mode === 'completed') {
    $('#viewCompleted').style.display = 'block';
  } else {
    $('#viewNotes').style.display = 'block';
  }
};

$('#refreshBtn').onclick = async () => {
  $('#refreshBtn').style.transform = 'rotate(360deg)';
  setTimeout(() => $('#refreshBtn').style.transform = '', 500);

  if (STATE.mode === 'tasks' || STATE.mode === 'completed') {
    await loadTasks();
  } else {
    await loadNotes();
  }
};

$('#addTaskBtn').onclick = () => {
  // This will invoke your iOS shortcut
  window.location.href = 'shortcuts://run-shortcut?name=Jarvis';
};

$('#tabTasks').onclick = async () => {
  if (STATE.mode === 'tasks') return;
  STATE.mode = 'tasks';
  $('#tabTasks').classList.add('active');
  $('#tabCompleted').classList.remove('active');
  $('#tabNotes').classList.remove('active');
  await loadTasks();
};

$('#tabCompleted').onclick = async () => {
  if (STATE.mode === 'completed') return;
  STATE.mode = 'completed';
  $('#tabCompleted').classList.add('active');
  $('#tabTasks').classList.remove('active');
  $('#tabNotes').classList.remove('active');
  renderCompleted();
};

$('#tabNotes').onclick = async () => {
  if (STATE.mode === 'notes') return;
  STATE.mode = 'notes';
  $('#tabNotes').classList.add('active');
  $('#tabTasks').classList.remove('active');
  $('#tabCompleted').classList.remove('active');
  await loadNotes();
};

// Edge-swipe to go back from detail (left-to-right)
(function enableBackSwipe(){
  let sx=0, sy=0, tracking=false;
  document.addEventListener('touchstart', e=>{
    if ($('#detail').style.display !== 'block') return;
    const t = e.touches[0]; 
    sx = t.clientX; 
    sy = t.clientY; 
    tracking = sx < 30; // left edge
  }, {passive:true});
  document.addEventListener('touchmove', e=>{
    if (!tracking) return;
    const dx = e.touches[0].clientX - sx;
    const dy = e.touches[0].clientY - sy;
    if (Math.abs(dy) > 40) tracking = false;
    if (dx > 80) { 
      $('#backBtn').click(); 
      tracking=false; 
    }
  }, {passive:true});
})();

// Event Listeners
$('#signOutBtn').onclick = signOut;

/* ---------- BOOT ---------- */
window.onload = function() {
  // Check if API URLs are configured
  if (API_CONFIG.GET_TASKS_URL.includes('YOUR-N8N-DOMAIN')) {
    const wrap = $('#viewTasks');
    wrap.innerHTML = `
      <div class="error">
        <p><strong>Setup Required:</strong></p>
        <p>Please update the API_CONFIG with your n8n webhook URLs.</p>
      </div>
    `;
    return;
  }

  // Check authentication on page load
  if (!checkAuth()) {
    return;
  }

  // Continue with app initialization
  loadTasks();
};
</script>
</body>
</html>